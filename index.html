<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Voiceflow + Push-to-Talk (stable bundle)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #vf-chat { height: 75vh; min-height: 520px; background:#0b1220; border-radius:12px; margin: 10px; }
    .ptt-btn{position:fixed;right:20px;bottom:20px;z-index:9999;width:56px;height:56px;border-radius:50%;border:none;cursor:pointer;background:#2563eb;color:#fff;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .ptt-btn.rec{background:#ef4444}
  </style>
</head>
<body style="margin:0;background:#0f172a;color:#e5e7eb;">
  <h1 style="padding:10px 12px;font-weight:600">Voiceflow Chat (Stable + PTT)</h1>
  <div id="vf-chat"></div>

  <!-- Stable bundle -->
  <script type="module" src="https://cdn.voiceflow.com/widget/bundle.mjs"></script>
  <script>
    window.voiceflow?.chat?.load({
      verify: { projectID: "68d9f429d1409c6c304d5485" },
      url: "https://general-runtime.voiceflow.com",
      versionID: "68d9f429d1409c6c304d5486",
      render: { mode: "embedded", target: document.getElementById("vf-chat") },
      autostart: true
    });
  </script>

  <!-- PTT that types & sends -->
  <script>
    (function(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR){ console.warn('Web Speech API not supported'); return; }
      let rec, isRec=false, text='';

      const btn=document.createElement('button');
      btn.className='ptt-btn'; btn.textContent='ðŸŽ¤'; document.body.appendChild(btn);

      function getEl(){
        const root=document.getElementById('vf-chat');
        return {
          input: root.querySelector('textarea, [role="textbox"]'),
          send: root.querySelector('button[aria-label="Send"],button[type="submit"]')
        };
      }
      function fill(t){ const {input}=getEl(); if(input){ input.value=t; input.dispatchEvent(new Event('input',{bubbles:true})); } }
      function send(){ const {send}=getEl(); if(send){ send.click(); } }

      function start(){
        if(isRec) return; isRec=true; text='';
        rec=new SR(); rec.lang='en-AU'; rec.interimResults=true; rec.continuous=true;
        rec.onresult=e=>{
          let interim=''; for(let i=e.resultIndex;i<e.results.length;i++){
            const seg=e.results[i][0].transcript;
            if(e.results[i].isFinal) text+=seg+' '; else interim+=seg;
          }
          fill(text+interim);
        };
        rec.onend=()=>{ if(isRec) stop(); }; rec.start(); btn.classList.add('rec');
      }
      function stop(){
        if(!isRec) return; isRec=false; try{rec.stop();}catch{}
        const t=text.trim(); if(t){ fill(t); send(); } btn.classList.remove('rec'); text='';
      }
      addEventListener('keydown',e=>{ if(e.code==='Space'&&!e.repeat){ e.preventDefault(); start(); } }, {passive:false});
      addEventListener('keyup',e=>{ if(e.code==='Space'){ e.preventDefault(); stop(); } }, {passive:false});
      btn.onclick=()=> isRec?stop():start();
    })();
  </script>
</body>
</html>
