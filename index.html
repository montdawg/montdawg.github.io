<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Voiceflow + Push-to-Talk (Stable Bundle)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { margin:0; font-family: system-ui, sans-serif; background:#0f172a; color:#e5e7eb; }
    h1 { margin: 10px; font-weight: 600; }
    #vf-chat { height: 75vh; min-height: 520px; background:#0b1220; border-radius: 12px; margin: 10px; overflow: hidden; }
    /* Mic button */
    .ptt-btn { position: fixed; right: 20px; bottom: 20px; z-index: 9999;
      width: 56px; height: 56px; border-radius: 50%; border: none; cursor: pointer;
      background: #2563eb; color: #fff; font-size: 24px; display:flex; align-items:center; justify-content:center;
      box-shadow: 0 8px 24px rgba(0,0,0,.35) }
    .ptt-btn.rec { background:#ef4444; animation:pulse 1.2s infinite }
    @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(239,68,68,.6)} 70%{box-shadow:0 0 0 16px rgba(239,68,68,0)} 100%{box-shadow:0 0 0 0 rgba(239,68,68,0)} }
  </style>
</head>
<body>
  <h1>Voiceflow Chat (Stable + Push-to-Talk)</h1>
  <p style="margin:0 10px 6px;color:#9ca3af;">Hold <kbd>Space</kbd> to talk, or click the mic button.</p>
  <div id="vf-chat"></div>

  <!-- Stable widget bundle -->
  <script type="module" src="https://cdn.voiceflow.com/widget/bundle.mjs"></script>
  <script>
    window.voiceflow?.chat?.load({
      verify: { projectID: "68d9f429d1409c6c304d5485" },
      url: "https://general-runtime.voiceflow.com",
      versionID: "68d9f429d1409c6c304d5486",
      render: { mode: "embedded", target: document.getElementById("vf-chat") },
      autostart: true
    });
  </script>

  <!-- Push-to-Talk -->
  <script>
    (function(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR){ console.warn('Web Speech API not supported'); return; }

      let rec, isRec=false, finalText='';

      const btn=document.createElement('button');
      btn.className='ptt-btn'; btn.textContent='ðŸŽ¤';
      document.body.appendChild(btn);

      function getEls(){
        const root=document.getElementById('vf-chat');
        return {
          input: root.querySelector('textarea, [role="textbox"]'),
          send: root.querySelector('button[aria-label="Send"],button[type="submit"]')
        };
      }

      function setInput(text){
        const {input}=getEls();
        if(input){
          input.value=text;
          input.dispatchEvent(new Event('input',{bubbles:true}));
        }
      }

      function clickSend(){
        const {send}=getEls();
        if(send) send.click();
      }

      function start(){
        if(isRec) return;
        isRec=true; finalText='';
        rec=new SR(); rec.lang='en-AU'; rec.interimResults=true; rec.continuous=true;
        rec.onresult=e=>{
          let interim='';
          for(let i=e.resultIndex;i<e.results.length;i++){
            const seg=e.results[i][0].transcript;
            if(e.results[i].isFinal) finalText+=seg+' ';
            else interim+=seg;
          }
          setInput((finalText+interim).trim());
        };
        rec.onend=()=>{ if(isRec) stop(); };
        rec.start(); btn.classList.add('rec');
      }

      function stop(){
        if(!isRec) return;
        isRec=false; try{rec.stop();}catch{}
        const text=finalText.trim();
        if(text){ setInput(text); clickSend(); }
        btn.classList.remove('rec'); finalText='';
      }

      addEventListener('keydown',e=>{ if(e.code==='Space'&&!e.repeat){ e.preventDefault(); start(); } }, {passive:false});
      addEventListener('keyup',e=>{ if(e.code==='Space'){ e.preventDefault(); stop(); } }, {passive:false});
      btn.onclick=()=> isRec?stop():start();
    })();
  </script>
</body>
</html>
