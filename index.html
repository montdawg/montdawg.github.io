<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Botpress + Push-to-Talk + Transcript</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    html, body { margin:0; height:100%; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#0f172a; color:#e5e7eb; }
    .wrap { display:grid; grid-template-columns: 2fr 1fr; gap:12px; height:100%; }
    .left { display:flex; flex-direction:column; }
    #bp-chat { flex:1; margin:12px; background:#0b1220; border-radius:12px; overflow:hidden; position:relative; min-height:520px; }
    .controls { padding:12px; margin:0 12px 12px; border:1px solid #1f2937; border-radius:12px; background:#0b1220; display:flex; gap:10px; align-items:center; }
    .kbd { font:600 12px ui-monospace,SFMono-Regular,Menlo,monospace; background:#111827; border:1px solid #374151; border-radius:6px; padding:2px 6px; color:#cbd5e1; }
    .ptt { margin-left:auto; width:46px; height:46px; border-radius:50%; border:none; background:#2563eb; color:#fff; font-size:20px; cursor:pointer; }
    .ptt.rec { background:#ef4444; animation:pulse 1.2s infinite }
    @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(239,68,68,.6)} 70%{box-shadow:0 0 0 12px rgba(239,68,68,0)} 100%{box-shadow:0 0 0 0 rgba(239,68,68,0)} }

    .right { margin:12px 12px 12px 0; background:#0b1220; border:1px solid #1f2937; border-radius:12px; display:flex; flex-direction:column; min-height:520px; }
    .right h2 { margin:12px; font-size:14px; color:#9ca3af; font-weight:600; }
    .log { flex:1; overflow:auto; padding:12px; display:flex; flex-direction:column; gap:10px; }
    .row { display:flex; gap:8px; align-items:flex-start; }
    .role { font-size:12px; padding:2px 6px; border-radius:999px; white-space:nowrap }
    .role.you { background:#1d4ed8; }
    .role.bot { background:#16a34a; }
    .bubble { background:#111827; border:1px solid #1f2937; border-radius:10px; padding:8px 10px; max-width: 100%; white-space:pre-wrap; }
    @media (max-width: 900px){ .wrap{ grid-template-columns: 1fr; } .right{ margin:0 12px 12px } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="left">
      <div id="bp-chat"></div>
      <div class="controls">
        <div>Hold <span class="kbd">Space</span> to talk, or press the mic.</div>
        <button id="ptt" class="ptt" title="Push to Talk">ðŸŽ¤</button>
      </div>
    </div>
    <aside class="right">
      <h2>Transcript</h2>
      <div id="log" class="log" aria-live="polite"></div>
    </aside>
  </div>

  <!-- Botpress WebChat -->
  <script src="https://cdn.botpress.cloud/webchat/v0/inject.js"></script>
  <script>
    window.botpressWebChat.init({
      botId: "365db4ca-6c8d-4e38-b127-d861518a0df7", // âœ… your Bot ID
      clientId: "3a67793f-ea73-4821-af6f-80fe1a1458bc", // âœ… your Client ID
      botName: "My Bot",
      hostUrl: "https://cdn.botpress.cloud/webchat/v0",
      messagingUrl: "https://messaging.botpress.cloud",
      lazySocket: true,
      useSessionStorage: true,
      showCloseButton: false,
      showConversationsButton: false,
      layoutWidth: "100%",
      hideWidget: true,
      container: document.getElementById("bp-chat")
    });

    window.botpressWebChat.onEvent(() => {
      window.botpressWebChat.open();
    }, ["LIFECYCLE.LOADED"]);
  </script>

  <!-- Push-to-Talk (Web Speech API) -->
  <script>
    (function(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const pttBtn = document.getElementById('ptt');
      const log = document.getElementById('log');

      function addRow(role, text){
        const row = document.createElement('div');
        row.className = 'row';
        const r = document.createElement('span');
        r.className = 'role ' + (role === 'You' ? 'you' : 'bot');
        r.textContent = role;
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.textContent = text;
        row.appendChild(r); row.appendChild(bubble);
        log.appendChild(row);
        log.scrollTop = log.scrollHeight;
      }

      if (!SR) { addRow('System', 'Web Speech API not supported.'); return; }

      let rec, isRec=false, finalText='', interimText='';

      function sendToBotpress(text) {
        try {
          if (window.botpressWebChat?.sendMessage) return window.botpressWebChat.sendMessage(text);
          if (window.botpressWebChat?.sendPayload) return window.botpressWebChat.sendPayload({ type: 'text', text });
        } catch(e) { console.warn("Send failed", e); }
      }

      function start() {
        if (isRec) return;
        isRec = true; finalText=''; interimText='';
        rec = new SR(); rec.lang='en-AU'; rec.interimResults=true; rec.continuous=true;
        rec.onresult = (e) => {
          interimText='';
          for (let i=e.resultIndex; i<e.results.length; i++) {
            const seg=e.results[i][0].transcript;
            if (e.results[i].isFinal) finalText+=seg+' ';
            else interimText+=seg;
          }
        };
        rec.onend = () => { if (isRec) stop(); };
        try { rec.start(); pttBtn.classList.add('rec'); } catch {}
      }

      function stop() {
        if (!isRec) return;
        isRec=false; try { rec && rec.stop(); } catch {}
        const text=(finalText||interimText||'').trim();
        if (text){ addRow('You', text); sendToBotpress(text); }
        finalText=''; interimText=''; pttBtn.classList.remove('rec');
      }

      function isTyping(){
        const ae=document.activeElement; if (!ae) return false;
        const tag=(ae.tagName||'').toLowerCase();
        return ae.isContentEditable||tag==='textarea'||(tag==='input'&&/text|search|email|tel|url/i.test(ae.type||'text'));
      }

      addEventListener('keydown',(e)=>{ if(e.code==='Space'&&!e.repeat&&!isTyping()){ e.preventDefault(); start(); }},{passive:false});
      addEventListener('keyup',(e)=>{ if(e.code==='Space'){ e.preventDefault(); stop(); }},{passive:false});
      pttBtn.addEventListener('mousedown', start);
      pttBtn.addEventListener('mouseup', stop);
    })();
  </script>
</body>
</html>
